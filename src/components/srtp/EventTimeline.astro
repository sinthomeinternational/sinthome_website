---
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';

interface Props {
  events: CollectionEntry<'srtpEvents'>[];
  lang?: 'en' | 'zh';
}

const { events, lang = 'en' } = Astro.props;

// Sort events by date (newest first)
const sortedEvents = events.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Group events by year
const eventsByYear = sortedEvents.reduce((acc, event) => {
  const year = event.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(event);
  return acc;
}, {} as Record<number, typeof sortedEvents>);

// Format date based on language
const formatDate = (date: Date) => {
  const options: Intl.DateTimeFormatOptions = { month: 'short', day: 'numeric' };
  return date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', options);
};
---

<div class="timeline-container">
  <!-- Timeline Navigation -->
  <nav class="timeline-nav sticky top-20 z-30 bg-black/90 backdrop-blur-sm border-b border-zinc-800 mb-8">
    <div class="flex gap-4 p-4 overflow-x-auto">
      {Object.keys(eventsByYear).sort((a, b) => Number(b) - Number(a)).map(year => (
        <a
          href={`#year-${year}`}
          class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition whitespace-nowrap"
        >
          {year}
        </a>
      ))}
    </div>
  </nav>

  <!-- Events Timeline -->
  <div class="relative">
    <!-- Vertical timeline line -->
    <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-red-600 via-red-600/50 to-transparent"></div>

    {Object.entries(eventsByYear).sort(([a], [b]) => Number(b) - Number(a)).map(([year, yearEvents]) => (
      <section id={`year-${year}`} class="mb-16">
        <!-- Year marker -->
        <div class="relative flex items-center mb-8">
          <div class="absolute left-8 w-4 h-4 bg-red-600 rounded-full -translate-x-1/2"></div>
          <h2 class="ml-20 text-3xl font-bold text-white">{year}</h2>
        </div>

        <!-- Events for this year -->
        <div class="space-y-6 ml-20">
          {yearEvents.map((event) => (
            <article class="group relative">
              <!-- Timeline dot -->
              <div class="absolute -left-12 top-6 w-2 h-2 bg-zinc-600 group-hover:bg-red-500 rounded-full transition"></div>

              <!-- Event Card -->
              <div class="bg-gradient-to-br from-zinc-900/80 via-zinc-900/50 to-zinc-900/30 border border-zinc-800 rounded-xl overflow-hidden hover:border-red-600/50 hover:shadow-xl hover:shadow-red-900/20 transition-all duration-300">
                <!-- Event Image Header -->
                {event.data.poster && (
                  <div class="relative h-48 overflow-hidden">
                    <Image
                      src={event.data.poster}
                      alt={`${event.data.title} poster`}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy"
                      format="webp"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                    <!-- Metadata overlays on image -->
                    <div class="absolute bottom-4 left-4 flex flex-wrap gap-2">
                      <span class="px-3 py-1 text-xs font-bold bg-red-600/90 text-white rounded-full backdrop-blur-sm">
                        {event.data.type}
                      </span>
                      <span class="px-3 py-1 text-xs font-medium bg-black/70 text-white rounded-full backdrop-blur-sm">
                        {formatDate(event.data.date)}
                      </span>
                      {event.data.featured && (
                        <span class="px-3 py-1 text-xs font-bold bg-yellow-500/90 text-black rounded-full backdrop-blur-sm">
                          Featured
                        </span>
                      )}
                    </div>
                  </div>
                )}

                <!-- Content Section -->
                <div class="p-6">
                  <!-- Metadata chips row (only if no image) -->
                  {!event.data.poster && (
                    <div class="flex flex-wrap gap-2 mb-4">
                      <span class="px-3 py-1 text-xs font-medium bg-red-600/20 text-red-400 rounded-full">
                        {event.data.type}
                      </span>
                      <span class="px-3 py-1 text-xs font-medium bg-zinc-800 text-zinc-400 rounded-full">
                        {formatDate(event.data.date)}
                      </span>
                      {event.data.duration && (
                        <span class="px-3 py-1 text-xs font-medium bg-zinc-800 text-zinc-400 rounded-full">
                          {event.data.duration}
                        </span>
                      )}
                      {event.data.featured && (
                        <span class="px-3 py-1 text-xs font-medium bg-yellow-600/20 text-yellow-400 rounded-full">
                          Featured
                        </span>
                      )}
                    </div>
                  )}

                  <!-- Title (bilingual) -->
                  <h3 class="text-xl font-bold text-white mb-3 hover:text-red-300 transition-colors">
                    {lang === 'zh' && event.data.titleZh ? event.data.titleZh : event.data.title}
                  </h3>

                  <!-- Synopsis -->
                  {(event.data.synopsis || event.data.synopsisZh) && (
                    <p class="text-zinc-400 mb-4 line-clamp-3 leading-relaxed">
                      {lang === 'zh' && event.data.synopsisZh ? event.data.synopsisZh : (event.data.synopsis || event.data.description || '')}
                    </p>
                  )}

                  <!-- Quote (if available) -->
                  {event.data.quote && (
                    <blockquote class="relative pl-6 border-l-3 border-red-600/50 text-zinc-500 italic text-sm mb-4 bg-zinc-800/20 p-4 rounded-r-lg">
                      <div class="absolute -top-1 -left-1">
                        <svg class="w-4 h-4 text-red-600/70" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h4v10h-10z"/>
                        </svg>
                      </div>
                      "{event.data.quote}"
                    </blockquote>
                  )}

                  <!-- Tags -->
                  {event.data.tags && event.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-6">
                      {event.data.tags.slice(0, 4).map(tag => (
                        <span class="text-xs text-zinc-500 bg-zinc-800/50 px-2 py-1 rounded">
                          #{tag}
                        </span>
                      ))}
                      {event.data.tags.length > 4 && (
                        <span class="text-xs text-zinc-600">
                          +{event.data.tags.length - 4} more
                        </span>
                      )}
                    </div>
                  )}

                  <!-- Location and Speaker Info -->
                  {(event.data.location || event.data.speaker) && (
                    <div class="flex flex-col gap-2 mb-4 text-sm text-zinc-500">
                      {event.data.location && (
                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          </svg>
                          <span class="truncate">{event.data.location}</span>
                        </div>
                      )}
                      {event.data.speaker && (
                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                          </svg>
                          <span class="truncate">{event.data.speaker}</span>
                        </div>
                      )}
                    </div>
                  )}

                  <!-- Actions Row -->
                  <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-zinc-700">
                    <a
                      href={`/events/${event.id}`}
                      class="flex-1 text-center px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white text-sm font-semibold rounded-lg hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-md hover:shadow-lg"
                    >
                      Learn More
                    </a>
                    {event.data.recordingUrl && (
                      <a
                        href={event.data.recordingUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="flex-1 text-center px-4 py-3 text-sm font-medium text-red-400 border border-red-600/50 hover:bg-red-600/10 rounded-lg transition-all duration-200 flex items-center justify-center gap-2"
                      >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                        Watch
                      </a>
                    )}
                  </div>
                </div>
              </div>
              </article>
            ))}
          </div>
        </section>
      ))}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .timeline-nav::-webkit-scrollbar {
    height: 4px;
  }

  .timeline-nav::-webkit-scrollbar-track {
    background: rgb(39 39 42);
  }

  .timeline-nav::-webkit-scrollbar-thumb {
    background: rgb(113 113 122);
    border-radius: 2px;
  }

  .timeline-nav::-webkit-scrollbar-thumb:hover {
    background: rgb(161 161 170);
  }
</style>