---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

interface Props {
  events: CollectionEntry<'srtpEvents'>[];
  lang?: 'en' | 'zh';
}

const { events, lang = 'en' } = Astro.props;

// Sort events by date (newest first)
const sortedEvents = events.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Group events by year
const eventsByYear = sortedEvents.reduce((acc, event) => {
  const year = event.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(event);
  return acc;
}, {} as Record<number, typeof sortedEvents>);

// Format date based on language
const formatDate = (date: Date) => {
  const options: Intl.DateTimeFormatOptions = { month: 'short', day: 'numeric' };
  return date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', options);
};
---

<div class="timeline-container">
  <!-- Timeline Navigation -->
  <nav class="timeline-nav sticky top-20 z-30 bg-black/90 backdrop-blur-sm border-b border-zinc-800 mb-8">
    <div class="flex gap-4 p-4 overflow-x-auto">
      {Object.keys(eventsByYear).sort((a, b) => Number(b) - Number(a)).map(year => (
        <a
          href={`#year-${year}`}
          class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition whitespace-nowrap"
        >
          {year}
        </a>
      ))}
    </div>
  </nav>

  <!-- Events Timeline -->
  <div class="relative">
    <!-- Vertical timeline line -->
    <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-red-600 via-red-600/50 to-transparent"></div>

    {Object.entries(eventsByYear).sort(([a], [b]) => Number(b) - Number(a)).map(([year, yearEvents]) => (
      <section id={`year-${year}`} class="mb-16">
        <!-- Year marker -->
        <div class="relative flex items-center mb-8">
          <div class="absolute left-8 w-4 h-4 bg-red-600 rounded-full -translate-x-1/2"></div>
          <h2 class="ml-20 text-3xl font-bold text-white">{year}</h2>
        </div>

        <!-- Events for this year -->
        <div class="space-y-6 ml-20">
          {yearEvents.map((event) => (
            <article class="group relative">
              <!-- Timeline dot -->
              <div class="absolute -left-12 top-6 w-2 h-2 bg-zinc-600 group-hover:bg-red-500 rounded-full transition"></div>

              <!-- Event Card -->
              <div class="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 hover:border-red-600/50 transition">
                <!-- Metadata chips row -->
                <div class="flex flex-wrap gap-2 mb-4">
                  <span class="px-3 py-1 text-xs font-medium bg-red-600/20 text-red-400 rounded-full">
                    {event.data.type}
                  </span>
                  <span class="px-3 py-1 text-xs font-medium bg-zinc-800 text-zinc-400 rounded-full">
                    {formatDate(event.data.date)}
                  </span>
                  <span class="px-3 py-1 text-xs font-medium bg-zinc-800 text-zinc-400 rounded-full">
                    {event.data.duration}
                  </span>
                  {event.data.featured && (
                    <span class="px-3 py-1 text-xs font-medium bg-yellow-600/20 text-yellow-400 rounded-full">
                      Featured
                    </span>
                  )}
                </div>

                <!-- Title (bilingual) -->
                <h3 class="text-xl font-bold text-white mb-2">
                  {lang === 'zh' ? event.data.titleZh : event.data.title}
                </h3>

                <!-- Synopsis -->
                <p class="text-zinc-400 mb-4 line-clamp-2">
                  {lang === 'zh' ? event.data.synopsisZh : event.data.synopsis}
                </p>

                <!-- Quote (if available) -->
                {event.data.quote && (
                  <blockquote class="pl-4 border-l-2 border-red-600/50 text-zinc-500 italic text-sm mb-4">
                    "{event.data.quote}"
                  </blockquote>
                )}

                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mb-4">
                  {event.data.tags.slice(0, 3).map(tag => (
                    <span class="text-xs text-zinc-500">#{tag}</span>
                  ))}
                </div>

                <!-- Actions Row -->
                <div class="flex items-center justify-between pt-4 border-t border-zinc-800">
                  <div class="flex items-center gap-2 text-sm text-zinc-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="truncate max-w-[200px]">{event.data.location}</span>
                  </div>

                  <div class="flex gap-3">
                    <a
                      href={`/events/${event.id}`}
                      class="px-4 py-2 text-sm font-medium text-white bg-zinc-800 hover:bg-zinc-700 rounded-lg transition"
                    >
                      Learn More
                    </a>
                    {event.data.recordingUrl && (
                      <a
                        href={event.data.recordingUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-4 py-2 text-sm font-medium text-red-400 border border-red-600/50 hover:bg-red-600/10 rounded-lg transition flex items-center gap-2"
                      >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                        Watch
                      </a>
                    )}
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      </section>
    ))}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .timeline-nav::-webkit-scrollbar {
    height: 4px;
  }

  .timeline-nav::-webkit-scrollbar-track {
    background: rgb(39 39 42);
  }

  .timeline-nav::-webkit-scrollbar-thumb {
    background: rgb(113 113 122);
    border-radius: 2px;
  }

  .timeline-nav::-webkit-scrollbar-thumb:hover {
    background: rgb(161 161 170);
  }
</style>